#!/usr/bin/env bash
#MISE description="Build XCFramework for Apple platforms"
set -euo pipefail

# Build XCFramework for Apple platforms
# This creates a universal framework that can be used on macOS, iOS, tvOS, and watchOS

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
BUILD_DIR="$PROJECT_ROOT/build-xcframework"
XCFRAMEWORK_PATH="$PROJECT_ROOT/SchlusselFFI.xcframework"

echo "Building XCFramework for Apple platforms..."
echo "============================================"
echo ""

# Clean previous builds
rm -rf "$BUILD_DIR"
rm -rf "$XCFRAMEWORK_PATH"
mkdir -p "$BUILD_DIR"

# Function to build for a specific target
build_for_target() {
    local target=$1
    local sdk=$2
    local output_name=$3

    echo "Building for $output_name (target: $target, sdk: $sdk)..."

    local build_path="$BUILD_DIR/$output_name"
    mkdir -p "$build_path"

    # Build static library
    zig build \
        -Dtarget="$target" \
        -Doptimize=ReleaseSafe \
        --prefix "$build_path"

    if [ $? -eq 0 ]; then
        echo "  ✓ Build successful for $output_name"
    else
        echo "  ✗ Build failed for $output_name"
        return 1
    fi

    echo ""
}

# Define Apple platform targets
# Format: "zig-target:sdk:output-name"
TARGETS=(
    "aarch64-macos:macosx:macos-arm64"
    "x86_64-macos:macosx:macos-x86_64"
    "aarch64-ios:iphoneos:ios-arm64"
    "aarch64-ios-simulator:iphonesimulator:ios-simulator-arm64"
    "x86_64-ios-simulator:iphonesimulator:ios-simulator-x86_64"
)

# Build for each target
for target_spec in "${TARGETS[@]}"; do
    IFS=':' read -r target sdk output_name <<< "$target_spec"
    build_for_target "$target" "$sdk" "$output_name" || echo "Warning: Build failed for $output_name"
done

# Create module map for the library
echo "Creating module map..."
MODULE_MAP_DIR="$BUILD_DIR/module"
mkdir -p "$MODULE_MAP_DIR"

cat > "$MODULE_MAP_DIR/module.modulemap" <<EOF
module SchlusselFFI {
    header "schlussel.h"
    export *
}
EOF

# Copy header to module directory
cp "$PROJECT_ROOT/include/schlussel.h" "$MODULE_MAP_DIR/"

echo ""
echo "Creating XCFramework..."

# Create framework structure for each platform
create_framework() {
    local platform=$1
    local arch=$2
    local sdk=$3

    local framework_path="$BUILD_DIR/${platform}-${arch}.framework"
    mkdir -p "$framework_path/Headers"
    mkdir -p "$framework_path/Modules"

    # Copy library
    local lib_path="$BUILD_DIR/${platform}-${arch}/lib/libschlussel.a"
    if [ -f "$lib_path" ]; then
        cp "$lib_path" "$framework_path/SchlusselFFI"
    else
        echo "Warning: Library not found at $lib_path"
        return 1
    fi

    # Copy headers
    cp "$PROJECT_ROOT/include/schlussel.h" "$framework_path/Headers/"

    # Copy module map
    cp "$MODULE_MAP_DIR/module.modulemap" "$framework_path/Modules/"

    # Create Info.plist
    cat > "$framework_path/Info.plist" <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>CFBundleDevelopmentRegion</key>
    <string>en</string>
    <key>CFBundleExecutable</key>
    <string>SchlusselFFI</string>
    <key>CFBundleIdentifier</key>
    <string>com.tuist.SchlusselFFI</string>
    <key>CFBundleInfoDictionaryVersion</key>
    <string>6.0</string>
    <key>CFBundleName</key>
    <string>SchlusselFFI</string>
    <key>CFBundlePackageType</key>
    <string>FMWK</string>
    <key>CFBundleShortVersionString</key>
    <string>0.1.0</string>
    <key>CFBundleVersion</key>
    <string>1</string>
    <key>CFBundleSupportedPlatforms</key>
    <array>
        <string>$sdk</string>
    </array>
</dict>
</plist>
EOF

    echo "  ✓ Created framework for ${platform}-${arch}"
}

# Create frameworks
create_framework "macos" "arm64" "MacOSX" || true
create_framework "macos" "x86_64" "MacOSX" || true
create_framework "ios" "arm64" "iPhoneOS" || true
create_framework "ios-simulator" "arm64" "iPhoneSimulator" || true
create_framework "ios-simulator" "x86_64" "iPhoneSimulator" || true

echo ""
echo "Creating fat binaries for simulators..."

# Create fat binary for iOS simulator (combine arm64 and x86_64)
if [ -f "$BUILD_DIR/ios-simulator-arm64.framework/SchlusselFFI" ] && \
   [ -f "$BUILD_DIR/ios-simulator-x86_64.framework/SchlusselFFI" ]; then

    mkdir -p "$BUILD_DIR/ios-simulator-universal.framework/Headers"
    mkdir -p "$BUILD_DIR/ios-simulator-universal.framework/Modules"

    lipo -create \
        "$BUILD_DIR/ios-simulator-arm64.framework/SchlusselFFI" \
        "$BUILD_DIR/ios-simulator-x86_64.framework/SchlusselFFI" \
        -output "$BUILD_DIR/ios-simulator-universal.framework/SchlusselFFI"

    cp -r "$BUILD_DIR/ios-simulator-arm64.framework/Headers/" "$BUILD_DIR/ios-simulator-universal.framework/Headers/"
    cp -r "$BUILD_DIR/ios-simulator-arm64.framework/Modules/" "$BUILD_DIR/ios-simulator-universal.framework/Modules/"
    cp "$BUILD_DIR/ios-simulator-arm64.framework/Info.plist" "$BUILD_DIR/ios-simulator-universal.framework/"

    echo "  ✓ Created universal iOS simulator framework"
fi

# Create fat binary for macOS (combine arm64 and x86_64)
if [ -f "$BUILD_DIR/macos-arm64.framework/SchlusselFFI" ] && \
   [ -f "$BUILD_DIR/macos-x86_64.framework/SchlusselFFI" ]; then

    mkdir -p "$BUILD_DIR/macos-universal.framework/Headers"
    mkdir -p "$BUILD_DIR/macos-universal.framework/Modules"

    lipo -create \
        "$BUILD_DIR/macos-arm64.framework/SchlusselFFI" \
        "$BUILD_DIR/macos-x86_64.framework/SchlusselFFI" \
        -output "$BUILD_DIR/macos-universal.framework/SchlusselFFI"

    cp -r "$BUILD_DIR/macos-arm64.framework/Headers/" "$BUILD_DIR/macos-universal.framework/Headers/"
    cp -r "$BUILD_DIR/macos-arm64.framework/Modules/" "$BUILD_DIR/macos-universal.framework/Modules/"
    cp "$BUILD_DIR/macos-arm64.framework/Info.plist" "$BUILD_DIR/macos-universal.framework/"

    echo "  ✓ Created universal macOS framework"
fi

echo ""
echo "Assembling XCFramework..."

# Build XCFramework with available frameworks
FRAMEWORK_ARGS=()

if [ -d "$BUILD_DIR/macos-universal.framework" ]; then
    FRAMEWORK_ARGS+=(-framework "$BUILD_DIR/macos-universal.framework")
fi

if [ -d "$BUILD_DIR/ios-arm64.framework" ]; then
    FRAMEWORK_ARGS+=(-framework "$BUILD_DIR/ios-arm64.framework")
fi

if [ -d "$BUILD_DIR/ios-simulator-universal.framework" ]; then
    FRAMEWORK_ARGS+=(-framework "$BUILD_DIR/ios-simulator-universal.framework")
fi

if [ ${#FRAMEWORK_ARGS[@]} -eq 0 ]; then
    echo "Error: No frameworks were built successfully"
    exit 1
fi

xcodebuild -create-xcframework \
    "${FRAMEWORK_ARGS[@]}" \
    -output "$XCFRAMEWORK_PATH"

echo ""
echo "============================================"
echo "XCFramework build complete!"
echo ""
echo "Output: $XCFRAMEWORK_PATH"
echo ""
echo "To use in Xcode:"
echo "  1. Drag SchlusselFFI.xcframework into your Xcode project"
echo "  2. Or use Swift Package Manager with Package.swift"
echo ""
